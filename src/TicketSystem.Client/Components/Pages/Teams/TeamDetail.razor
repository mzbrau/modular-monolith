@page "/teams/{TeamId}"
@using TicketSystem.Team.Grpc
@using TicketSystem.User.Grpc
@using TicketSystem.Client.Services
@inject TeamGrpcClient TeamClient
@inject UserGrpcClient UserClient
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Team Details</PageTitle>

@if (_team == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <h1>@_team.Name</h1>

    <div class="row">
        <div class="col-md-8">
            @if (_isEditing)
            {
                <EditForm Model="@_editModel" OnValidSubmit="HandleUpdate" FormName="EditTeamForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <InputText id="name" @bind-Value="_editModel.Name" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <InputTextArea id="description" @bind-Value="_editModel.Description" class="form-control" rows="3" />
                    </div>

                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <div class="alert alert-danger">@_errorMessage</div>
                    }

                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                </EditForm>
            }
            else
            {
                <dl class="row">
                    <dt class="col-sm-3">Description</dt>
                    <dd class="col-sm-9">@(_team.Description ?? "-")</dd>

                    <dt class="col-sm-3">Created</dt>
                    <dd class="col-sm-9">@DateTime.Parse(_team.CreatedDate).ToLocalTime().ToString("g")</dd>
                </dl>

                <div class="mt-3 mb-4">
                    <button class="btn btn-primary" @onclick="StartEdit">Edit</button>
                    <a href="/teams" class="btn btn-secondary">Back to List</a>
                </div>

                <h3>Team Members</h3>

                @if (!_isAddingMember)
                {
                    <button class="btn btn-sm btn-outline-primary mb-3" @onclick="StartAddMember">Add Member</button>
                }
                else
                {
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-5">
                                    <label class="form-label">User</label>
                                    <select @bind="_selectedUserId" class="form-select">
                                        <option value="">Select a user...</option>
                                        @foreach (var user in _availableUsers)
                                        {
                                            <option value="@user.Id">@user.DisplayName (@user.Email)</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Role</label>
                                    <select @bind="_selectedRole" class="form-select">
                                        <option value="0">Member</option>
                                        <option value="1">Lead</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-primary" @onclick="HandleAddMember">Add</button>
                                    <button class="btn btn-secondary" @onclick="CancelAddMember">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                @if (_team.Members.Count == 0)
                {
                    <p>No members yet.</p>
                }
                else
                {
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Role</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var member in _team.Members)
                            {
                                var userInfo = _userLookup.GetValueOrDefault(member.UserId);
                                <tr>
                                    <td>@(userInfo?.DisplayName ?? member.UserId)</td>
                                    <td>@(member.Role == 1 ? "Lead" : "Member")</td>
                                    <td>@DateTime.Parse(member.JoinedDate).ToLocalTime().ToString("g")</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => HandleRemoveMember(member.UserId)">Remove</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public string TeamId { get; set; } = string.Empty;

    private TeamMessage? _team;
    private EditTeamModel _editModel = new();
    private bool _isEditing;
    private bool _isAddingMember;
    private string? _errorMessage;
    private List<UserMessage> _availableUsers = new();
    private Dictionary<string, UserMessage> _userLookup = new();
    private string _selectedUserId = string.Empty;
    private int _selectedRole;

    protected override async Task OnInitializedAsync()
    {
        await LoadTeam();
        await LoadUsers();
    }

    private async Task LoadTeam()
    {
        _team = await TeamClient.GetTeamAsync(TeamId);
        if (_team == null)
        {
            Navigation.NavigateTo("/teams");
        }
    }

    private async Task LoadUsers()
    {
        var users = await UserClient.ListUsersAsync();
        _userLookup = users.Where(u => u.IsActive).ToDictionary(u => u.Id, u => u);
        
        // Filter out users already in the team
        var memberIds = _team?.Members.Select(m => m.UserId).ToHashSet() ?? new HashSet<string>();
        _availableUsers = users.Where(u => u.IsActive && !memberIds.Contains(u.Id)).ToList();
    }

    private void StartEdit()
    {
        _editModel = new EditTeamModel
        {
            Name = _team!.Name,
            Description = _team.Description
        };
        _isEditing = true;
    }

    private void CancelEdit()
    {
        _isEditing = false;
        _errorMessage = null;
    }

    private async Task HandleUpdate()
    {
        _errorMessage = null;

        try
        {
            await TeamClient.UpdateTeamAsync(TeamId, _editModel.Name!, _editModel.Description ?? string.Empty);
            await LoadTeam();
            _isEditing = false;
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private void StartAddMember()
    {
        _isAddingMember = true;
        _selectedUserId = string.Empty;
        _selectedRole = 0;
    }

    private void CancelAddMember()
    {
        _isAddingMember = false;
    }

    private async Task HandleAddMember()
    {
        if (string.IsNullOrEmpty(_selectedUserId))
            return;

        try
        {
            await TeamClient.AddMemberToTeamAsync(TeamId, _selectedUserId, _selectedRole);
            await LoadTeam();
            await LoadUsers();
            _isAddingMember = false;
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private async Task HandleRemoveMember(string userId)
    {
        try
        {
            await TeamClient.RemoveMemberFromTeamAsync(TeamId, userId);
            await LoadTeam();
            await LoadUsers();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private class EditTeamModel
    {
        public string? Name { get; set; }
        public string? Description { get; set; }
    }
}
