@page "/issues"
@using TicketSystem.Issue.Infrastructure.Grpc
@using TicketSystem.Team.Infrastructure.Grpc
@using TicketSystem.User.Infrastructure.Grpc
@using TicketSystem.Client.Services
@inject IssueGrpcClient IssueClient
@inject UserGrpcClient UserClient
@inject TeamGrpcClient TeamClient
@rendermode InteractiveServer

<PageTitle>Issues</PageTitle>

<h1>Issues</h1>

<div class="mb-3">
    <a href="/issues/create" class="btn btn-primary">Create New Issue</a>
</div>

<div class="row mb-3">
    <div class="col-md-3">
        <label class="form-label">Filter by Status</label>
        <select @bind="_statusFilter" @bind:after="ApplyFilters" class="form-select">
            <option value="">All Statuses</option>
            <option value="0">Open</option>
            <option value="1">In Progress</option>
            <option value="2">Blocked</option>
            <option value="3">Resolved</option>
            <option value="4">Closed</option>
        </select>
    </div>
    <div class="col-md-3">
        <label class="form-label">Filter by Assignee</label>
        <select @bind="_userFilter" @bind:after="ApplyFilters" class="form-select">
            <option value="">All Users</option>
            @foreach (var user in _users)
            {
                <option value="@user.Id">@user.DisplayName</option>
            }
        </select>
    </div>
</div>

@if (_filteredIssues == null)
{
    <p><em>Loading...</em></p>
}
else if (_filteredIssues.Count == 0)
{
    <p>No issues found.</p>
}
else
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Title</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Assigned To</th>
                <th>Due Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var issue in _filteredIssues)
            {
                <tr>
                    <td>@issue.Title</td>
                    <td>
                        <span class="badge @GetStatusBadgeClass(issue.Status)">@GetStatusName(issue.Status)</span>
                    </td>
                    <td>
                        <span class="badge @GetPriorityBadgeClass(issue.Priority)">@GetPriorityName(issue.Priority)</span>
                    </td>
                    <td>@GetAssigneeName(issue)</td>
                    <td>@(string.IsNullOrEmpty(issue.DueDate) ? "-" : DateTime.Parse(issue.DueDate).ToLocalTime().ToString("d"))</td>
                    <td>
                        <a href="/issues/@issue.Id" class="btn btn-sm btn-outline-primary">View</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<IssueMessage>? _issues;
    private List<IssueMessage>? _filteredIssues;
    private List<UserMessage> _users = new();
    private List<TeamMessage> _teams = new();
    private Dictionary<string, UserMessage> _userLookup = new();
    private Dictionary<string, TeamMessage> _teamLookup = new();
    private string _statusFilter = string.Empty;
    private string _userFilter = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var issuesTask = IssueClient.ListIssuesAsync();
        var usersTask = UserClient.ListUsersAsync();
        var teamsTask = TeamClient.ListTeamsAsync();

        await Task.WhenAll(issuesTask, usersTask, teamsTask);

        _issues = issuesTask.Result;
        _users = usersTask.Result;
        _teams = teamsTask.Result;
        _userLookup = _users.ToDictionary(u => u.Id, u => u);
        _teamLookup = _teams.ToDictionary(t => t.Id, t => t);
        
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        _filteredIssues = _issues?
            .Where(t => string.IsNullOrEmpty(_statusFilter) || t.Status.ToString() == _statusFilter)
            .Where(t => string.IsNullOrEmpty(_userFilter) || t.AssignedUserId == _userFilter)
            .OrderByDescending(t => t.Priority)
            .ThenBy(t => t.Status)
            .ToList();
    }

    private string GetAssigneeName(IssueMessage issue)
    {
        if (!string.IsNullOrEmpty(issue.AssignedUserId) && _userLookup.TryGetValue(issue.AssignedUserId, out var user))
            return user.DisplayName;
        if (!string.IsNullOrEmpty(issue.AssignedTeamId) && _teamLookup.TryGetValue(issue.AssignedTeamId, out var team))
            return $"Team: {team.Name}";
        return "Unassigned";
    }

    private string GetStatusName(int status) => status switch
    {
        0 => "Open",
        1 => "In Progress",
        2 => "Blocked",
        3 => "Resolved",
        4 => "Closed",
        _ => "Unknown"
    };

    private string GetStatusBadgeClass(int status) => status switch
    {
        0 => "bg-info",
        1 => "bg-primary",
        2 => "bg-danger",
        3 => "bg-success",
        4 => "bg-secondary",
        _ => "bg-light"
    };

    private string GetPriorityName(int priority) => priority switch
    {
        0 => "Low",
        1 => "Medium",
        2 => "High",
        3 => "Critical",
        _ => "Unknown"
    };

    private string GetPriorityBadgeClass(int priority) => priority switch
    {
        0 => "bg-secondary",
        1 => "bg-info",
        2 => "bg-warning text-dark",
        3 => "bg-danger",
        _ => "bg-light"
    };
}
